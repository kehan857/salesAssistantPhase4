# é”€å”®AIåŠ©æ‰‹å››æœŸ - æŠ€æœ¯æ¶æ„è¯¦ç»†è®¾è®¡

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¥æœŸ**: 2026-01-12

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [å‰ç«¯æ¶æ„è®¾è®¡](#å‰ç«¯æ¶æ„è®¾è®¡)
3. [åç«¯æ¶æ„è®¾è®¡](#åç«¯æ¶æ„è®¾è®¡)
4. [AI/MLæ¶æ„è®¾è®¡](#aimlæ¶æ„è®¾è®¡)
5. [æ•°æ®æ¶æ„è®¾è®¡](#æ•°æ®æ¶æ„è®¾è®¡)
6. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
7. [éƒ¨ç½²æ¶æ„](#éƒ¨ç½²æ¶æ„)

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®¢æˆ·ç«¯å±‚ (Client Layer)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  Web App     â”‚  â”‚  æ¡Œé¢å®¢æˆ·ç«¯  â”‚  â”‚  ç§»åŠ¨ç«¯App   â”‚              â”‚
â”‚  â”‚  (React)     â”‚  â”‚  (Electron)  â”‚  â”‚  (React Native)â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“ HTTPS/WSS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APIç½‘å…³å±‚ (API Gateway)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Nginx / Kong                                                 â”‚  â”‚
â”‚  â”‚  - è´Ÿè½½å‡è¡¡                                                    â”‚  â”‚
â”‚  â”‚  - SSLç»ˆç»“                                                    â”‚  â”‚
â”‚  â”‚  - é™æµç†”æ–­                                                    â”‚  â”‚
â”‚  â”‚  - è¯·æ±‚è·¯ç”±                                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨æœåŠ¡å±‚ (Application Layer)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  APIæœåŠ¡     â”‚  â”‚  AIç¼–æ’æœåŠ¡  â”‚  â”‚  å·¥ä½œæµå¼•æ“  â”‚              â”‚
â”‚  â”‚  (NestJS)    â”‚  â”‚  (LangChain) â”‚  â”‚  (Temporal)  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AIæ¨¡å‹å±‚ (AI Model Layer)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚  LLM Gateway â”‚  â”‚  å¾®è°ƒæ¨¡å‹    â”‚  â”‚  Embedding   â”‚              â”‚
â”‚  â”‚  (GPT-4o/    â”‚  â”‚  (Llama 3.1) â”‚  â”‚  æœåŠ¡        â”‚              â”‚
â”‚  â”‚   Claude)    â”‚  â”‚              â”‚  â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ•°æ®å±‚ (Data Layer)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ PostgreSQL   â”‚  â”‚  Redis       â”‚  â”‚  Milvus/     â”‚              â”‚
â”‚  â”‚ (å…³ç³»æ•°æ®åº“)  â”‚  â”‚  (ç¼“å­˜/é˜Ÿåˆ—)  â”‚  â”‚  Pinecone    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  â”‚  S3/MinIO    â”‚  â”‚  ä¼ä¸šå¾®ä¿¡/    â”‚                               â”‚
â”‚  â”‚  (å¯¹è±¡å­˜å‚¨)   â”‚  â”‚  CRM API     â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ å‰ç«¯æ¶æ„è®¾è®¡

### æŠ€æœ¯æ ˆ

```json
{
  "framework": "React 18.3",
  "language": "TypeScript 5.3",
  "build_tool": "Vite 5.0",
  "state_management": "Zustand 4.4 + React Query 5.0",
  "ui_library": "Shadcn/ui + Radix UI",
  "styling": "Tailwind CSS 3.4",
  "charts": "Recharts 2.10 + D3.js 7.8",
  "editor": "Tiptap 2.1",
  "realtime": "Socket.io Client 4.6",
  "testing": "Vitest + Testing Library"
}
```

### ç›®å½•ç»“æ„

```
sales-assistant-frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # é¡µé¢å…¥å£
â”‚   â”‚   â”œâ”€â”€ dashboard/          # ä¸»æ§å°
â”‚   â”‚   â”œâ”€â”€ conversations/      # å¯¹è¯ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ leads/              # çº¿ç´¢ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ knowledge/          # çŸ¥è¯†åº“
â”‚   â”‚   â””â”€â”€ analytics/          # æ•°æ®åˆ†æ
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ ui/                 # åŸºç¡€UIç»„ä»¶ï¼ˆshadcn/uiï¼‰
â”‚   â”‚   â”œâ”€â”€ copilot/            # Copilotä¾§è¾¹æ 
â”‚   â”‚   â”œâ”€â”€ charts/             # å›¾è¡¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ forms/              # è¡¨å•ç»„ä»¶
â”‚   â”‚   â””â”€â”€ layouts/            # å¸ƒå±€ç»„ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ features/               # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ bant-extractor/     # BANTæå–
â”‚   â”‚   â”œâ”€â”€ sentiment-analysis/ # æƒ…æ„Ÿåˆ†æ
â”‚   â”‚   â”œâ”€â”€ text-polisher/      # æ–‡æ¡ˆæ¶¦è‰²
â”‚   â”‚   â”œâ”€â”€ nurture-workflow/   # åŸ¹è‚²å·¥ä½œæµ
â”‚   â”‚   â””â”€â”€ knowledge-feedback/ # çŸ¥è¯†åé¦ˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                  # è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”œâ”€â”€ useSocket.ts        # WebSocketè¿æ¥
â”‚   â”‚   â”œâ”€â”€ useAI.ts            # AIè°ƒç”¨
â”‚   â”‚   â””â”€â”€ useCRM.ts           # CRMé›†æˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ services/               # APIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ api.ts              # APIå®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ socket.ts           # WebSocketæœåŠ¡
â”‚   â”‚   â””â”€â”€ crm.ts              # CRMé›†æˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ stores/                 # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ conversationStore.ts
â”‚   â”‚   â”œâ”€â”€ leadStore.ts
â”‚   â”‚   â””â”€â”€ userStore.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                    # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â””â”€â”€ constants.ts
â”‚   â”‚
â”‚   â””â”€â”€ styles/                 # æ ·å¼æ–‡ä»¶
â”‚       â”œâ”€â”€ globals.css
â”‚       â””â”€â”€ tailwind.css
â”‚
â”œâ”€â”€ public/                     # é™æ€èµ„æº
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ vite.config.ts
â””â”€â”€ tailwind.config.js
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. Copilotä¾§è¾¹æ 

```typescript
// src/components/copilot/CopilotSidebar.tsx
interface CopilotSidebarProps {
  conversationId: string;
  leadId: string;
}

export const CopilotSidebar: React.FC<CopilotSidebarProps> = ({
  conversationId,
  leadId
}) => {
  const [suggestions, setSuggestions] = useState<Suggestion[]>([]);
  const [bantData, setBantData] = useState<BANTData | null>(null);

  useEffect(() => {
    // WebSocketç›‘å¬å®æ—¶å»ºè®®
    socket.on('ai:suggestion', (data) => {
      setSuggestions(prev => [...prev, data]);
    });

    // è·å–BANTæ•°æ®
    api.get(`/conversations/${conversationId}/bant`)
      .then(res => setBantData(res.data));
  }, [conversationId]);

  return (
    <div className="copilot-sidebar">
      {/* å®æ—¶å»ºè®®å¡ç‰‡ */}
      <SuggestionCard suggestions={suggestions} />

      {/* BANTæƒ…æŠ¥å¡ç‰‡ */}
      <BANTCard data={bantData} />

      {/* æ–‡æ¡ˆæ¶¦è‰²å·¥å…· */}
      <TextPolisher />

      {/* æƒ…æ„Ÿåˆ†æå›¾è¡¨ */}
      <SentimentChart />
    </div>
  );
};
```

#### 2. BANTæƒ…æŠ¥å¡ç‰‡

```typescript
// src/components/copilot/BANTCard.tsx
interface BANTCardProps {
  data: BANTData | null;
}

export const BANTCard: React.FC<BANTCardProps> = ({ data }) => {
  if (!data) return <Skeleton />;

  return (
    <Card className="bant-card">
      <CardHeader>
        <CardTitle>ğŸ“Š BANTæƒ…æŠ¥</CardTitle>
      </CardHeader>
      <CardContent>
        <BANTItem
          label="é¢„ç®— (Budget)"
          value={data.budget}
          confidence={data.budgetConfidence}
          icon="ğŸ’°"
        />
        <BANTItem
          label="æƒé™ (Authority)"
          value={data.authority}
          confidence={data.authorityConfidence}
          icon="ğŸ‘¤"
        />
        <BANTItem
          label="éœ€æ±‚ (Need)"
          value={data.need}
          confidence={data.needConfidence}
          icon="ğŸ¯"
        />
        <BANTItem
          label="æ—¶é—´ (Timeline)"
          value={data.timeline}
          confidence={data.timelineConfidence}
          icon="ğŸ“…"
        />

        {/* ä½ç½®ä¿¡åº¦æç¤º */}
        {data.confidence < 0.85 && (
          <Alert variant="warning">
            <AlertCircle className="h-4 w-4" />
            <AlertTitle>éƒ¨åˆ†ä¿¡æ¯ç½®ä¿¡åº¦è¾ƒä½</AlertTitle>
            <AlertDescription>
              è¯·é”€å”®äººå‘˜ç¡®è®¤ä»¥ä¸Šä¿¡æ¯
            </AlertDescription>
          </Alert>
        )}
      </CardContent>
    </Card>
  );
};
```

#### 3. æ–‡æ¡ˆæ¶¦è‰²å·¥å…·

```typescript
// src/components/copilot/TextPolisher.tsx
export const TextPolisher: React.FC = () => {
  const [input, setInput] = useState('');
  const [polished, setPolished] = useState('');
  const [tone, setTone] = useState<Tone>('professional');
  const [isLoading, setIsLoading] = useState(false);

  const handlePolish = async () => {
    setIsLoading(true);
    try {
      const result = await api.post('/ai/polish', {
        text: input,
        tone: tone
      });
      setPolished(result.data.polishedText);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>âœï¸ æ–‡æ¡ˆæ¶¦è‰²</CardTitle>
      </CardHeader>
      <CardContent>
        <Textarea
          placeholder="è¾“å…¥æ‚¨çš„å›å¤..."
          value={input}
          onChange={(e) => setInput(e.target.value)}
        />

        {/* è¯­æ°”é€‰æ‹© */}
        <div className="tone-selector">
          <Button
            variant={tone === 'professional' ? 'default' : 'outline'}
            onClick={() => setTone('professional')}
          >
            å•†åŠ¡ä¸“ä¸š
          </Button>
          <Button
            variant={tone === 'friendly' ? 'default' : 'outline'}
            onClick={() => setTone('friendly')}
          >
            äº²å’Œçƒ­æƒ…
          </Button>
          <Button
            variant={tone === 'urgent' ? 'default' : 'outline'}
            onClick={() => setTone('urgent')}
          >
            ç´§è¿«ä¿ƒå•
          </Button>
        </div>

        <Button
          onClick={handlePolish}
          disabled={isLoading || !input}
        >
          {isLoading ? <Spinner /> : 'ç”Ÿæˆæ¶¦è‰²'}
        </Button>

        {/* æ¶¦è‰²ç»“æœ */}
        {polished && (
          <div className="polished-result">
            <label>æ¶¦è‰²åï¼š</label>
            <p>{polished}</p>
            <div className="actions">
              <Button size="sm">é‡‡ç”¨</Button>
              <Button size="sm" variant="outline">å¤åˆ¶</Button>
              <Button size="sm" variant="ghost">åé¦ˆ</Button>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
};
```

### çŠ¶æ€ç®¡ç†

```typescript
// src/stores/conversationStore.ts
import create from 'zustand';

interface ConversationStore {
  conversations: Conversation[];
  activeConversation: Conversation | null;
  realtimeSuggestions: Suggestion[];

  setActiveConversation: (id: string) => void;
  addSuggestion: (suggestion: Suggestion) => void;
  updateBANTData: (conversationId: string, data: BANTData) => void;
}

export const useConversationStore = create<ConversationStore>((set) => ({
  conversations: [],
  activeConversation: null,
  realtimeSuggestions: [],

  setActiveConversation: (id) => {
    set((state) => ({
      activeConversation: state.conversations.find(c => c.id === id)
    }));
  },

  addSuggestion: (suggestion) => {
    set((state) => ({
      realtimeSuggestions: [...state.realtimeSuggestions, suggestion]
    }));
  },

  updateBANTData: (conversationId, data) => {
    set((state) => ({
      conversations: state.conversations.map(c =>
        c.id === conversationId ? { ...c, bantData: data } : c
      )
    }));
  }
}));
```

### APIæœåŠ¡å±‚

```typescript
// src/services/api.ts
import axios from 'axios';
import { useUserStore } from '@/stores/userStore';

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  timeout: 30000
});

// è¯·æ±‚æ‹¦æˆªå™¨ï¼šæ·»åŠ Token
apiClient.interceptors.request.use((config) => {
  const token = useUserStore.getState().token;
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});

// å“åº”æ‹¦æˆªå™¨ï¼šé”™è¯¯å¤„ç†
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.response?.status === 401) {
      // è·³è½¬ç™»å½•
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export const api = {
  // å¯¹è¯ç›¸å…³
  getConversations: () => apiClient.get('/conversations'),
  getConversation: (id: string) => apiClient.get(`/conversations/${id}`),
  getBANTData: (id: string) => apiClient.get(`/conversations/${id}/bant`),

  // AIç›¸å…³
  polishText: (text: string, tone: string) =>
    apiClient.post('/ai/polish', { text, tone }),
  generateScript: (scenario: string, context: any) =>
    apiClient.post('/ai/script', { scenario, context }),

  // çº¿ç´¢ç›¸å…³
  getLeads: () => apiClient.get('/leads'),
  getLead: (id: string) => apiClient.get(`/leads/${id}`),
  updateLead: (id: string, data: any) =>
    apiClient.put(`/leads/${id}`, data)
};

export default api;
```

### å®æ—¶é€šä¿¡

```typescript
// src/services/socket.ts
import { io, Socket } from 'socket.io-client';

class SocketService {
  private socket: Socket | null = null;
  private listeners: Map<string, Function[]> = new Map();

  connect(token: string) {
    this.socket = io(import.meta.env.VITE_WS_URL, {
      auth: { token },
      transports: ['websocket']
    });

    this.socket.on('connect', () => {
      console.log('WebSocket connected');
    });

    this.socket.on('disconnect', () => {
      console.log('WebSocket disconnected');
    });

    // æ³¨å†Œå…¨å±€ç›‘å¬å™¨
    this.listeners.forEach((cbs, event) => {
      cbs.forEach(cb => {
        this.socket?.on(event, cb);
      });
    });
  }

  on(event: string, callback: Function) {
    if (!this.listeners.has(event)) {
      this.listeners.set(event, []);
    }
    this.listeners.get(event)?.push(callback);

    this.socket?.on(event, callback);
  }

  emit(event: string, data: any) {
    this.socket?.emit(event, data);
  }

  disconnect() {
    this.socket?.disconnect();
  }
}

export const socketService = new SocketService();
```

---

## âš™ï¸ åç«¯æ¶æ„è®¾è®¡

### æŠ€æœ¯æ ˆ

```json
{
  "runtime": "Node.js 20 LTS",
  "framework": "NestJS 10.3",
  "language": "TypeScript 5.3",
  "orm": "Prisma 5.8",
  "validation": "class-validator + class-transformer",
  "authentication": "JWT + Passport",
  "queue": "BullMQ 5.1",
  "cache": "Redis 7.2",
  "docs": "Swagger/OpenAPI 3.0"
}
```

### ç›®å½•ç»“æ„

```
sales-assistant-backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/               # ä¸šåŠ¡æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth/              # è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ conversations/     # å¯¹è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ leads/             # çº¿ç´¢æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ knowledge/         # çŸ¥è¯†åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ nurture/           # åŸ¹è‚²æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ ai/                # AIæœåŠ¡æ¨¡å—
â”‚   â”‚   â””â”€â”€ crm/               # CRMé›†æˆæ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ guards/            # å®ˆå«
â”‚   â”‚   â”œâ”€â”€ decorators/        # è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ filters/           # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â”‚   â”œâ”€â”€ interceptors/      # æ‹¦æˆªå™¨
â”‚   â”‚   â””â”€â”€ pipes/             # ç®¡é“
â”‚   â”‚
â”‚   â”œâ”€â”€ config/                # é…ç½®
â”‚   â”‚   â”œâ”€â”€ database.ts
â”‚   â”‚   â”œâ”€â”€ redis.ts
â”‚   â”‚   â””â”€â”€ ai.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ ai/                    # AIæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ llm/               # LLMé›†æˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ gateway.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ openai.ts
â”‚   â”‚   â”‚   â””â”€â”€ claude.ts
â”‚   â”‚   â”œâ”€â”€ agents/            # AIæ™ºèƒ½ä½“
â”‚   â”‚   â”‚   â”œâ”€â”€ bant-extractor.agent.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ sentiment.agent.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ polisher.agent.ts
â”‚   â”‚   â”‚   â””â”€â”€ script-generator.agent.ts
â”‚   â”‚   â”œâ”€â”€ rag/               # RAGç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ vector-store.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ retriever.ts
â”‚   â”‚   â”‚   â””â”€â”€ feedback-loop.ts
â”‚   â”‚   â””â”€â”€ prompts/           # Promptæ¨¡æ¿
â”‚   â”‚       â”œâ”€â”€ bant.prompt.ts
â”‚   â”‚       â”œâ”€â”€ polish.prompt.ts
â”‚   â”‚       â””â”€â”€ script.prompt.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ jobs/                  # åå°ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ sync-crm.job.ts
â”‚   â”‚   â”œâ”€â”€ analyze-conversation.job.ts
â”‚   â”‚   â””â”€â”€ nurture-send.job.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ websocket/             # WebSocket
â”‚   â”‚   â”œâ”€â”€ gateway.ts
â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚
â”‚   â””â”€â”€ main.ts                # å…¥å£
â”‚
â”œâ”€â”€ prisma/                    # Prisma ORM
â”‚   â”œâ”€â”€ schema.prisma
â”‚   â””â”€â”€ migrations/
â”‚
â”œâ”€â”€ test/                      # æµ‹è¯•
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ nest-cli.json
```

### æ ¸å¿ƒæ¨¡å—è®¾è®¡

#### 1. å¯¹è¯æ¨¡å— (Conversations Module)

```typescript
// src/modules/conversations/conversations.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from '@/common/prisma/prisma.service';
import { BANTExtractorAgent } from '@/ai/agents/bant-extractor.agent';
import { SentimentAgent } from '@/ai/agents/sentiment.agent';

@Injectable()
export class ConversationsService {
  constructor(
    private prisma: PrismaService,
    private bantAgent: BANTExtractorAgent,
    private sentimentAgent: SentimentAgent,
  ) {}

  async createConversation(data: CreateConversationDto) {
    const conversation = await this.prisma.conversation.create({
      data: {
        leadId: data.leadId,
        channel: data.channel,
        messages: data.messages || []
      }
    });

    // è§¦å‘å¼‚æ­¥åˆ†æ
    await this.analyzeConversation(conversation.id);

    return conversation;
  }

  async analyzeConversation(conversationId: string) {
    const conversation = await this.prisma.conversation.findUnique({
      where: { id: conversationId },
      include: { messages: true }
    });

    // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªåˆ†æ
    const [bantData, sentimentScore] = await Promise.all([
      this.bantAgent.extract(conversation.messages),
      this.sentimentAgent.analyze(conversation.messages)
    ]);

    // æ›´æ–°åˆ†æç»“æœ
    await this.prisma.conversation.update({
      where: { id: conversationId },
      data: {
        bantData,
        sentimentScore,
        riskLevel: this.calculateRiskLevel(sentimentScore)
      }
    });

    // é€šè¿‡WebSocketæ¨é€åˆ°å‰ç«¯
    this.websocketGateway.emitToLead(
      conversation.leadId,
      'conversation:analyzed',
      { bantData, sentimentScore }
    );
  }

  async getBANTData(conversationId: string) {
    return this.prisma.conversation.findUnique({
      where: { id: conversationId },
      select: { bantData: true }
    });
  }

  private calculateRiskLevel(sentiment: number): 'low' | 'medium' | 'high' {
    if (sentiment > 0.7) return 'low';
    if (sentiment > 0.4) return 'medium';
    return 'high';
  }
}
```

#### 2. AIæœåŠ¡æ¨¡å— (AI Module)

```typescript
// src/modules/ai/ai.service.ts
import { Injectable } from '@nestjs/common';
import { LLMGateway } from '@/ai/llm/gateway';
import { POLISH_PROMPT } from '@/ai/prompts/polish.prompt';

@Injectable()
export class AIService {
  constructor(private llmGateway: LLMGateway) {}

  async polishText(dto: PolishTextDto) {
    const prompt = POLISH_PROMPT
      .replace('{{text}}', dto.text)
      .replace('{{tone}}', dto.tone);

    const polishedText = await this.llmGateway.generate({
      prompt,
      model: 'gpt-4o',
      temperature: 0.7
    });

    return { polishedText };
  }

  async generateScript(dto: GenerateScriptDto) {
    const prompt = this.buildPromptForScenario(dto.scenario, dto.context);

    const script = await this.llmGateway.generate({
      prompt,
      model: 'gpt-4o',
      temperature: 0.8
    });

    return { script };
  }

  private buildPromptForScenario(scenario: string, context: any): string {
    // æ ¹æ®åœºæ™¯æ„å»ºPrompt
    const templates = {
      cold_outreach: COLD_OUTREACH_PROMPT,
      follow_up: FOLLOW_UP_PROMPT,
      closing: CLOSING_PROMPT
    };
    return templates[scenario].replace('{{context}}', JSON.stringify(context));
  }
}
```

#### 3. LLMç½‘å…³ (LLM Gateway)

```typescript
// src/ai/llm/gateway.ts
import { OpenAI } from 'openai';
import Anthropic from '@anthropic-ai/sdk';

@Injectable()
export class LLMGateway {
  private openai: OpenAI;
  private anthropic: Anthropic;

  constructor() {
    this.openai = new OpenAI({
      apiKey: process.env.OPENAI_API_KEY
    });
    this.anthropic = new Anthropic({
      apiKey: process.env.ANTHROPIC_API_KEY
    });
  }

  async generate(params: GenerateParams): Promise<string> {
    const { model, prompt, temperature = 0.7 } = params;

    // æ ¹æ®æ¨¡å‹é€‰æ‹©è·¯ç”±
    if (model.startsWith('gpt')) {
      return this.callOpenAI(params);
    } else if (model.startsWith('claude')) {
      return this.callAnthropic(params);
    } else {
      throw new Error(`Unsupported model: ${model}`);
    }
  }

  private async callOpenAI(params: GenerateParams): Promise<string> {
    const response = await this.openai.chat.completions.create({
      model: params.model,
      messages: [{ role: 'user', content: params.prompt }],
      temperature: params.temperature
    });
    return response.choices[0].message.content;
  }

  private async callAnthropic(params: GenerateParams): Promise<string> {
    const response = await this.anthropic.messages.create({
      model: params.model,
      max_tokens: 4096,
      messages: [{ role: 'user', content: params.prompt }]
    });
    return response.content[0].type === 'text' ? response.content[0].text : '';
  }
}
```

#### 4. BANTæå–Agent

```typescript
// src/ai/agents/bant-extractor.agent.ts
import { Injectable } from '@nestjs/common';
import { LLMGateway } from '@/ai/llm/gateway';
import { BANT_EXTRACTOR_PROMPT } from '@/ai/prompts/bant.prompt';

interface BANTData {
  budget: {
    amount?: number;
    source?: string;
    approvalRequired: boolean;
    confidence: number;
  };
  authority: {
    decisionMaker: string;
    influencers: string[];
    currentContactRole: string;
    confidence: number;
  };
  need: {
    painPoints: string[];
    goals: string[];
    solutionFit: string;
    confidence: number;
  };
  timeline: {
    purchaseDate?: Date;
    urgency: 'low' | 'medium' | 'high';
    milestones: string[];
    confidence: number;
  };
  overallConfidence: number;
}

@Injectable()
export class BANTExtractorAgent {
  constructor(private llm: LLMGateway) {}

  async extract(messages: Message[]): Promise<BANTData> {
    // 1. æ„å»ºä¸Šä¸‹æ–‡
    const context = this.buildContext(messages);

    // 2. è°ƒç”¨LLMæå–
    const prompt = BANT_EXTRACTOR_PROMPT.replace('{{context}}', context);
    const response = await this.llm.generate({
      prompt,
      model: 'gpt-4o',
      temperature: 0.3 // ä½æ¸©åº¦ä¿è¯ç¨³å®šæ€§
    });

    // 3. è§£æJSONå“åº”
    const bantData = JSON.parse(response);

    // 4. ç½®ä¿¡åº¦è¯„åˆ†
    return this.scoreConfidence(bantData);
  }

  private buildContext(messages: Message[]): string {
    return messages.map(m => `[${m.role}] ${m.content}`).join('\n');
  }

  private scoreConfidence(bantData: BANTData): BANTData {
    // è®¡ç®—æ•´ä½“ç½®ä¿¡åº¦ï¼ˆå››ä¸ªç»´åº¦çš„å¹³å‡ï¼‰
    const scores = [
      bantData.budget.confidence,
      bantData.authority.confidence,
      bantData.need.confidence,
      bantData.timeline.confidence
    ];
    bantData.overallConfidence = scores.reduce((a, b) => a + b) / scores.length;

    return bantData;
  }
}
```

#### 5. RAGç³»ç»Ÿ (RAG System)

```typescript
// src/ai/rag/vector-store.ts
import { MilvusClient } from '@zilliz/milvus2-sdk-node';

@Injectable()
export class VectorStore {
  private client: MilvusClient;
  private collectionName = 'knowledge_base';

  constructor() {
    this.client = new MilvusClient({
      address: process.env.MILVUS_ADDRESS
    });
  }

  async insert(documents: KnowledgeDocument[]) {
    const embeddings = await this.generateEmbeddings(documents);

    const data = documents.map((doc, i) => ({
      id: doc.id,
      vector: embeddings[i],
      metadata: doc.metadata
    }));

    await this.client.insert({
      collection_name: this.collectionName,
      data
    });
  }

  async search(query: string, topK: number = 5): Promise<KnowledgeDocument[]> {
    const queryVector = await this.generateEmbedding(query);

    const results = await this.client.search({
      collection_name: this.collectionName,
      vector: queryVector,
      limit: topK
    });

    return results.map(result => ({
      id: result.id,
      content: result.metadata.content,
      score: result.score
    }));
  }

  private async generateEmbeddings(texts: string[]): Promise<number[][]> {
    // è°ƒç”¨OpenAI Embedding API
    const response = await openai.embeddings.create({
      model: 'text-embedding-3-large',
      input: texts
    });
    return response.data.map(d => d.embedding);
  }

  private async generateEmbedding(text: string): Promise<number[]> {
    const embeddings = await this.generateEmbeddings([text]);
    return embeddings[0];
  }
}
```

#### 6. å·¥ä½œæµå¼•æ“ (Nurture Workflow)

```typescript
// src/modules/nurture/nurture.service.ts
import { Injectable } from '@nestjs/common';
import { InjectQueue } from '@nestjs/bullmq';
import { Queue } from 'bullmq';

@Injectable()
export class NurtureService {
  constructor(
    @InjectQueue('nurture') private nurtureQueue: Queue,
    private prisma: PrismaService
  ) {}

  async startNurturePlan(leadId: string) {
    const plan = await this.prisma.nurturePlan.create({
      data: {
        leadId,
        currentDay: 1,
        status: 'active',
        nextActionAt: this.calculateNextActionTime(1)
      }
    });

    // æ·»åŠ Day 1ä»»åŠ¡åˆ°é˜Ÿåˆ—
    await this.nurtureQueue.add('day-1', { planId: plan.id }, {
      delay: 0 // ç«‹å³æ‰§è¡Œ
    });

    return plan;
  }

  async handleBehaviorEvent(leadId: string, behavior: Behavior) {
    const plan = await this.prisma.nurturePlan.findUnique({
      where: { leadId }
    });

    // å¼‚å¸¸ä¼˜å…ˆï¼šè¡Œä¸ºè§¦å‘è¦†ç›–æ—¶é—´è§¦å‘
    if (behavior.type === 'view_pricing') {
      await this.jumpToDay(plan.id, 'price_objection');
    }

    // é«˜æ½œæ²‰é»˜ï¼šç‚¹å‡»ä½†æœªå›å¤
    if (behavior.type === 'click_link' && !behavior.replied) {
      await this.notifySales(leadId, 'high_potential_silent');
    }
  }

  private async jumpToDay(planId: string, scenario: string) {
    // å–æ¶ˆå½“å‰ç­‰å¾…çš„ä»»åŠ¡
    await this.nurtureQueue.remove(planId);

    // æ·»åŠ æ–°çš„ä»»åŠ¡
    await this.nurtureQueue.add(
      scenario,
      { planId },
      { delay: 0 }
    );
  }

  private calculateNextActionTime(day: number): Date {
    const now = new Date();
    const daysToAdd = day === 1 ? 0 : 1;
    now.setDate(now.getDate() + daysToAdd);
    now.setHours(10, 0, 0, 0); // ä¸Šåˆ10ç‚¹å‘é€
    return now;
  }
}
```

### WebSocketç½‘å…³

```typescript
// src/websocket/gateway.ts
import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  OnGatewayConnection,
  OnGatewayDisconnect
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';

@WebSocketGateway({
  cors: { origin: '*' },
  transports: ['websocket']
})
export class WebsocketGateway implements OnGatewayConnection, OnGatewayDisconnect {
  @WebSocketServer()
  server: Server;

  private userSockets = new Map<string, Set<string>>();

  async handleConnection(client: Socket) {
    const userId = this.extractUserId(client);
    this.addToUserSockets(userId, client.id);
    console.log(`User ${userId} connected`);
  }

  async handleDisconnect(client: Socket) {
    const userId = this.extractUserId(client);
    this.removeFromUserSockets(userId, client.id);
  }

  @SubscribeMessage('subscribe:lead')
  handleSubscribeToLead(client: Socket, leadId: string) {
    client.join(`lead:${leadId}`);
  }

  emitToLead(leadId: string, event: string, data: any) {
    this.server.to(`lead:${leadId}`).emit(event, data);
  }

  emitToUser(userId: string, event: string, data: any) {
    const sockets = this.userSockets.get(userId) || [];
    sockets.forEach(socketId => {
      this.server.to(socketId).emit(event, data);
    });
  }

  private extractUserId(client: Socket): string {
    return client.handshake.auth.userId;
  }

  private addToUserSockets(userId: string, socketId: string) {
    if (!this.userSockets.has(userId)) {
      this.userSockets.set(userId, new Set());
    }
    this.userSockets.get(userId)?.add(socketId);
  }

  private removeFromUserSockets(userId: string, socketId: string) {
    this.userSockets.get(userId)?.delete(socketId);
  }
}
```

---

## ğŸ¤– AI/MLæ¶æ„è®¾è®¡

### Promptå·¥ç¨‹

#### BANTæå–Prompt

```typescript
// src/ai/prompts/bant.prompt.ts
export const BANT_EXTRACTOR_PROMPT = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„é”€å”®æƒ…æŠ¥åˆ†æä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹å¯¹è¯å†…å®¹ï¼Œæå–BANTä¿¡æ¯ã€‚

**å¯¹è¯å†…å®¹ï¼š**
{{context}}

**æå–è¦æ±‚ï¼š**

1. **é¢„ç®— (Budget)**
   - é¢„ç®—é‡‘é¢ï¼ˆå¦‚æœ‰æåŠï¼‰
   - èµ„é‡‘æ¥æº
   - æ˜¯å¦éœ€è¦å®¡æ‰¹
   - ç½®ä¿¡åº¦ (0-1)

2. **æƒé™ (Authority)**
   - å†³ç­–äººæ˜¯è°
   - å½±å“è€…æœ‰å“ªäº›
   - å½“å‰è”ç³»äººçš„è§’è‰²
   - ç½®ä¿¡åº¦ (0-1)

3. **éœ€æ±‚ (Need)**
   - æ ¸å¿ƒç—›ç‚¹
   - ä¸šåŠ¡ç›®æ ‡
   - ä¸æˆ‘ä»¬äº§å“çš„åŒ¹é…åº¦
   - ç½®ä¿¡åº¦ (0-1)

4. **æ—¶é—´ (Timeline)**
   - é¢„è®¡é‡‡è´­æ—¶é—´
   - ç´§è¿«ç¨‹åº¦ (low/medium/high)
   - å…³é”®é‡Œç¨‹ç¢‘
   - ç½®ä¿¡åº¦ (0-1)

**è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š**
{
  "budget": {
    "amount": "æ•°å­—æˆ–null",
    "source": "å­—ç¬¦ä¸²æˆ–null",
    "approvalRequired": true/false,
    "confidence": 0.0-1.0
  },
  "authority": {
    "decisionMaker": "å­—ç¬¦ä¸²æˆ–null",
    "influencers": ["å­—ç¬¦ä¸²æ•°ç»„"],
    "currentContactRole": "å­—ç¬¦ä¸²",
    "confidence": 0.0-1.0
  },
  "need": {
    "painPoints": ["å­—ç¬¦ä¸²æ•°ç»„"],
    "goals": ["å­—ç¬¦ä¸²æ•°ç»„"],
    "solutionFit": "å­—ç¬¦ä¸²",
    "confidence": 0.0-1.0
  },
  "timeline": {
    "purchaseDate": "æ—¥æœŸå­—ç¬¦ä¸²æˆ–null",
    "urgency": "low/medium/high",
    "milestones": ["å­—ç¬¦ä¸²æ•°ç»„"],
    "confidence": 0.0-1.0
  }
}

**æ³¨æ„äº‹é¡¹ï¼š**
- åªæå–å¯¹è¯ä¸­æ˜ç¡®æåŠçš„ä¿¡æ¯ï¼Œä¸è¦è‡†æµ‹
- å¦‚æœä¿¡æ¯ä¸æ˜ç¡®ï¼Œç½®ä¿¡åº¦åº”ä½äº0.7
- æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸ºISO 8601
- ç¡®ä¿è¾“å‡ºçš„æ˜¯æœ‰æ•ˆJSONæ ¼å¼
`;
```

#### æ–‡æ¡ˆæ¶¦è‰²Prompt

```typescript
// src/ai/prompts/polish.prompt.ts
export const POLISH_PROMPT = `
ä½ æ˜¯ä¸€ä½èµ„æ·±çš„é”€å”®æ²Ÿé€šä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥çš„ç®€çŸ­æ„å›¾ï¼Œç”Ÿæˆä¸€æ®µä¸“ä¸šã€æœ‰è¯´æœåŠ›çš„å›å¤ã€‚

**ç”¨æˆ·è¾“å…¥ï¼š**
{{text}}

**æœŸæœ›è¯­æ°”ï¼š**
{{tone}}

**è¯­æ°”è¯´æ˜ï¼š**
- professionalï¼šå•†åŠ¡ä¸“ä¸šï¼Œæ­£å¼å¾—ä½“
- friendlyï¼šäº²å’Œçƒ­æƒ…ï¼Œæ‹‰è¿‘è·ç¦»
- urgentï¼šç´§è¿«ä¿ƒå•ï¼Œåˆ¶é€ ç¨€ç¼ºæ„Ÿ

**è¦æ±‚ï¼š**
1. ä¿æŒæ ¸å¿ƒä¿¡æ¯ä¸å˜
2. å¢å¼ºè¯´æœåŠ›å’Œä¸“ä¸šæ€§
3. æ ¹æ®è¯­æ°”è°ƒæ•´è¡¨è¾¾æ–¹å¼
4. é•¿åº¦æ§åˆ¶åœ¨100-200å­—
5. ç›´æ¥è¾“å‡ºæ¶¦è‰²åçš„æ–‡æœ¬ï¼Œä¸è¦è§£é‡Š

**è¾“å‡ºï¼š**
[æ¶¦è‰²åçš„å›å¤]
`;
```

### æ¨¡å‹å¾®è°ƒæµç¨‹

```python
# scripts/finetune_champion_model.py
from axolotl import train
import json

# 1. å‡†å¤‡è®­ç»ƒæ•°æ®
def prepare_training_data():
    # ä»æ•°æ®åº“å¯¼å‡ºé”€å† å¯¹è¯
    champion_conversations = db.query("""
        SELECT * FROM conversations
        WHERE sales_id IN (
            SELECT id FROM sales
            WHERE conversion_rate_rank <= 10
        )
        AND converted = true
    """)

    # æ„å»ºè®­ç»ƒæ ·æœ¬
    training_data = []
    for conv in champion_conversations:
        for message in conv.messages:
            if message.role == 'assistant':
                training_data.append({
                    'instruction': message.context,
                    'output': message.content,
                    'input': ''
                })

    # ä¿å­˜ä¸ºJSONL
    with open('champion_data.jsonl', 'w') as f:
        for item in training_data:
            f.write(json.dumps(item) + '\n')

# 2. é…ç½®å¾®è°ƒå‚æ•°
def finetune_model():
    config = {
        'base_model': 'meta-llama/Llama-3.1-8B',
        'data_path': 'champion_data.jsonl',
        'output_dir': './champion-model-v1',
        'num_train_epochs': 3,
        'learning_rate': 2e-5,
        'lora_r': 8,
        'lora_alpha': 16,
        'batch_size': 4
    }

    # æ‰§è¡Œå¾®è°ƒ
    train(config)

if __name__ == '__main__':
    prepare_training_data()
    finetune_model()
```

---

## ğŸ’¾ æ•°æ®æ¶æ„è®¾è®¡

### Prisma Schema

```prisma
// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ç”¨æˆ·æ¨¡å‹
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  name          String?
  role          UserRole  @default(SALES)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  conversations Conversation[]
  leads         Lead[]
}

enum UserRole {
  ADMIN
  SALES_MANAGER
  SALES
}

// å¯¹è¯æ¨¡å‹
model Conversation {
  id             String       @id @default(uuid())
  leadId         String
  lead           Lead         @relation(fields: [leadId], references: [id])
  channel        ChannelType
  messages       Json
  bantData       Json?
  sentimentScore Decimal?     @db.Decimal(3, 2)
  riskLevel      RiskLevel?
  status         ConversationStatus @default(ACTIVE)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([leadId])
  @@index([sentimentScore])
}

enum ChannelType {
  WECHAT
  EMAIL
  PHONE
  WEBCHAT
}

enum ConversationStatus {
  ACTIVE
  ARCHIVED
  CONVERTED
  LOST
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

// çº¿ç´¢æ¨¡å‹
model Lead {
  id                  String       @id @default(uuid())
  name                String
  company             String?
  title               String?
  email               String?
  phone               String?
  source              LeadSource   @default(OTHER)
  status              LeadStatus   @default(NEW)
  assignedToId        String?
  assignedTo          User?        @relation(fields: [assignedToId], references: [id])
  conversations       Conversation[]
  nurturePlan         NurturePlan?
  score               Int          @default(0)
  tags                String[]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@index([status])
  @@index([score])
}

enum LeadSource {
  WEBSITE
  WECHAT
  REFERRAL
  EVENT
  ADVERTISING
  OTHER
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  CONVERTED
  LOST
}

// åŸ¹è‚²è®¡åˆ’æ¨¡å‹
model NurturePlan {
  id              String           @id @default(uuid())
  leadId          String           @unique
  lead            Lead             @relation(fields: [leadId], references: [id])
  currentDay      Int              @default(1)
  status          NurtureStatus    @default(ACTIVE)
  lastActionAt    DateTime?
  nextActionAt    DateTime?
  metadata        Json?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([status])
  @@index([nextActionAt])
}

enum NurtureStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// çŸ¥è¯†åº“æ¨¡å‹
model KnowledgeItem {
  id              String         @id @default(uuid())
  question        String
  answer          String
  embedding       Unsupported(Float[])?
  tags            String[]
  feedbackScore   Int            @default(0)
  freshnessScore  Int            @default(100)
  status          KnowledgeStatus @default(DRAFT)
  createdBy       String
  updatedBy       String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@index([freshnessScore])
}

enum KnowledgeStatus {
  DRAFT
  PENDING_REVIEW
  PUBLISHED
  ARCHIVED
}

// åé¦ˆæ•°æ®æ¨¡å‹
model FeedbackData {
  id              String      @id @default(uuid())
  conversationId  String?
  suggestionId    String?
  actionType      FeedbackAction
  originalContent String?
  modifiedContent String?
  userId          String?
  createdAt       DateTime    @default(now())

  @@index([actionType])
}

enum FeedbackAction {
  ACCEPT
  MODIFY
  REJECT
  FLAG
}

// CRMé›†æˆæ—¥å¿—
model CRM SyncLog {
  id          String      @id @default(uuid())
  entityType  String
  entityId    String
  action      SyncAction
  status      SyncStatus
  errorMessage String?
  createdAt   DateTime    @default(now())

  @@index([entityType, entityId])
  @@index([status])
}

enum SyncAction {
  CREATE
  UPDATE
  DELETE
}

enum SyncStatus {
  SUCCESS
  FAILED
  PENDING
}
```

---

## ğŸ”Œ APIæ¥å£è®¾è®¡

### RESTful APIè§„èŒƒ

#### å¯¹è¯ç›¸å…³æ¥å£

```typescript
// GET /api/conversations
// è·å–å¯¹è¯åˆ—è¡¨
interface GetConversationsQuery {
  leadId?: string;
  status?: ConversationStatus;
  page?: number;
  limit?: number;
}

interface ConversationsResponse {
  data: Conversation[];
  total: number;
  page: number;
  limit: number;
}

// POST /api/conversations
// åˆ›å»ºå¯¹è¯
interface CreateConversationDto {
  leadId: string;
  channel: ChannelType;
  messages?: Message[];
}

// GET /api/conversations/:id
// è·å–å¯¹è¯è¯¦æƒ…
interface ConversationResponse {
  data: Conversation;
}

// GET /api/conversations/:id/bant
// è·å–BANTæ•°æ®
interface BANTResponse {
  data: BANTData;
}

// POST /api/conversations/:id/analyze
// è§¦å‘å¯¹è¯åˆ†æ
interface AnalyzeConversationResponse {
  taskId: string;
}
```

#### AIç›¸å…³æ¥å£

```typescript
// POST /api/ai/polish
// æ–‡æ¡ˆæ¶¦è‰²
interface PolishTextDto {
  text: string;
  tone: 'professional' | 'friendly' | 'urgent';
  context?: string;
}

interface PolishTextResponse {
  polishedText: string;
  suggestions?: string[];
}

// POST /api/ai/script
// ç”Ÿæˆé”€å”®å‰§æœ¬
interface GenerateScriptDto {
  scenario: 'cold_outreach' | 'follow_up' | 'closing' | 'objection_handling';
  context: {
    prospectName: string;
    company: string;
    industry: string;
    painPoints?: string[];
  };
}

interface GenerateScriptResponse {
  script: string;
  talkingPoints: string[];
  expectedObjections: string[];
}

// POST /api/ai/feedback
// æäº¤AIåé¦ˆ
interface SubmitFeedbackDto {
  type: 'accept' | 'modify' | 'reject';
  suggestionId: string;
  originalContent: string;
  modifiedContent?: string;
  rating?: number;
}
```

#### çº¿ç´¢ç›¸å…³æ¥å£

```typescript
// GET /api/leads
// è·å–çº¿ç´¢åˆ—è¡¨
interface GetLeadsQuery {
  status?: LeadStatus;
  assignedTo?: string;
  page?: number;
  limit?: number;
  sortBy?: string;
  sortOrder?: 'asc' | 'desc';
}

// POST /api/leads
// åˆ›å»ºçº¿ç´¢
interface CreateLeadDto {
  name: string;
  company?: string;
  email?: string;
  phone?: string;
  source?: LeadSource;
  tags?: string[];
}

// PUT /api/leads/:id
// æ›´æ–°çº¿ç´¢
interface UpdateLeadDto {
  status?: LeadStatus;
  score?: number;
  tags?: string[];
  assignedToId?: string;
}

// POST /api/leads/:id/nurture
// å¯åŠ¨åŸ¹è‚²è®¡åˆ’
interface StartNurtureResponse {
  planId: string;
  estimatedEndDate: string;
}
```

### WebSocketäº‹ä»¶

```typescript
// å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨

// è®¢é˜…çº¿ç´¢æ›´æ–°
socket.emit('subscribe:lead', { leadId: string });

// å‘é€æ¶ˆæ¯
socket.emit('message:send', {
  conversationId: string,
  content: string,
  attachments?: string[]
});

// è¯·æ±‚AIå»ºè®®
socket.emit('ai:request-suggestion', {
  conversationId: string,
  context: string
});

// æäº¤åé¦ˆ
socket.emit('feedback:submit', {
  suggestionId: string,
  action: 'accept' | 'modify' | 'reject',
  modifiedContent?: string
});

// æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯

// AIå®æ—¶å»ºè®®
socket.on('ai:suggestion', {
  suggestionId: string,
  content: string,
  type: 'reply' | 'objection_handling' | 'next_action',
  confidence: number
});

// å¯¹è¯åˆ†æå®Œæˆ
socket.on('conversation:analyzed', {
  conversationId: string,
  bantData: BANTData,
  sentimentScore: number
});

// çº¿ç´¢çŠ¶æ€æ›´æ–°
socket.on('lead:updated', {
  leadId: string,
  changes: Record<string, any>
});

// æ–°æ¶ˆæ¯
socket.on('message:new', {
  conversationId: string,
  message: Message
});

// é£é™©é¢„è­¦
socket.on('risk:alert', {
  leadId: string,
  level: 'low' | 'medium' | 'high',
  message: string,
  suggestedAction: string
});
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### Docker Composeé…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  # å‰ç«¯
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - VITE_API_URL=http://api:8000
      - VITE_WS_URL=ws://api:8000
    depends_on:
      - api

  # åç«¯API
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/sales_assistant
      - REDIS_URL=redis://redis:6379
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - MILVUS_ADDRESS=milvus:19530
    depends_on:
      - postgres
      - redis
      - milvus

  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:16
    environment:
      - POSTGRES_DB=sales_assistant
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Milvuså‘é‡æ•°æ®åº“
  milvus:
    image: milvusdb/milvus:latest
    environment:
      - ETCD_ENDPOINTS=etcd:2379
      - MINIO_ADDRESS=minio:9000
    depends_on:
      - etcd
      - minio
    ports:
      - "19530:19530"

  # etcd (Milvusä¾èµ–)
  etcd:
    image: quay.io/coreos/etcd:latest
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
    volumes:
      - etcd_data:/etcd

  # MinIO (Milvusä¾èµ–)
  minio:
    image: minio/minio:latest
    environment:
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
    volumes:
      - minio_data:/minio_data
    command: minio server /minio_data

  # BullMQ Dashboard
  bullmq-board:
    image: deadmist/frontail:latest
    command: bullmq-board --redis-host redis
    ports:
      - "3001:3000"
    depends_on:
      - redis

volumes:
  postgres_data:
  redis_data:
  etcd_data:
  minio_data:
```

### Kubernetesé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sales-assistant-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: sales-assistant-api
  template:
    metadata:
      labels:
        app: sales-assistant-api
    spec:
      containers:
      - name: api
        image: registry.example.com/sales-assistant-api:latest
        ports:
        - containerPort: 8000
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-secret
              key: url
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: ai-secret
              key: openai-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /health
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 8000
          initialDelaySeconds: 5
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: sales-assistant-api-service
spec:
  selector:
    app: sales-assistant-api
  ports:
  - protocol: TCP
    port: 80
    targetPort: 8000
  type: LoadBalancer
```

---

**ğŸ“„ æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**ğŸ‘¤ æ¶æ„å¸ˆ**: Claude Code (Sonnet 4.5)
**ğŸ“… æœ€åæ›´æ–°**: 2026-01-12
